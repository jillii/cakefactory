"use strict";const assert=require("assert").strict,parseCacheControl=require("parse-cache-control"),Audit=require("../audit.js"),NetworkRequest=require("../../lib/network-request.js"),URL=require("../../lib/url-shim.js"),linearInterpolation=require("../../lib/statistics.js").linearInterpolation,i18n=require("../../lib/i18n/i18n.js"),NetworkRecords=require("../../computed/network-records.js"),UIStrings={title:"Uses efficient cache policy on static assets",failureTitle:"Serve static assets with an efficient cache policy",description:"A long cache lifetime can speed up repeat visits to your page. [Learn more](https://web.dev/uses-long-cache-ttl).",displayValue:"{itemCount, plural,\n    =1 {1 resource found}\n    other {# resources found}\n    }"},str_=i18n.createMessageInstanceIdFn(__filename,UIStrings),IGNORE_THRESHOLD_IN_PERCENT=.925;class CacheHeaders extends Audit{static get meta(){return{id:"uses-long-cache-ttl",title:str_(UIStrings.title),failureTitle:str_(UIStrings.failureTitle),description:str_(UIStrings.description),scoreDisplayMode:Audit.SCORING_MODES.NUMERIC,requiredArtifacts:["devtoolsLogs","traces"]}}static get defaultOptions(){return{scorePODR:4096,scoreMedian:131072}}static getCacheHitProbability(e){const t=[0,.2,1,3,8,12,24,48,72,168,8760,1/0];assert.ok(12===t.length,"deciles 0-10 and 1 for overflow");const s=e/3600,r=t.findIndex(e=>e>=s);if(r===t.length-1)return 1;if(0===r)return 0;const i=t[r],a=t[r-1];return linearInterpolation(a,(r-1)/10,i,r/10,s)}static computeCacheLifetimeInSeconds(e,t){if(t&&void 0!==t["max-age"])return t["max-age"];const s=e.get("expires");if(s){const e=new Date(s).getTime();return e?Math.ceil((e-Date.now())/1e3):0}return null}static isCacheableAsset(e){const t=new Set([200,203,206]),s=new Set([NetworkRequest.TYPES.Font,NetworkRequest.TYPES.Image,NetworkRequest.TYPES.Media,NetworkRequest.TYPES.Script,NetworkRequest.TYPES.Stylesheet]);return!URL.NON_NETWORK_PROTOCOLS.includes(e.protocol)&&(t.has(e.statusCode)&&s.has(e.resourceType||"Other"))}static shouldSkipRecord(e,t){return!(t||!(e.get("pragma")||"").includes("no-cache"))||!(!t||!(t["must-revalidate"]||t["no-cache"]||t["no-store"]||t.private))}static audit(e,t){const s=e.devtoolsLogs[Audit.DEFAULT_PASS];return NetworkRecords.request(s,t).then(e=>{const s=[];let r=0,i=0;for(const t of e){if(!CacheHeaders.isCacheableAsset(t))continue;const e=new Map;for(const s of t.responseHeaders||[])if(e.has(s.name.toLowerCase())){const t=e.get(s.name.toLowerCase());e.set(s.name.toLowerCase(),`${t}, ${s.value}`)}else e.set(s.name.toLowerCase(),s.value);const a=parseCacheControl(e.get("cache-control"));if(this.shouldSkipRecord(e,a))continue;let o=CacheHeaders.computeCacheLifetimeInSeconds(e,a);if(null!==o&&(!Number.isFinite(o)||o<=0))continue;o=o||0;const n=CacheHeaders.getCacheHitProbability(o);if(n>IGNORE_THRESHOLD_IN_PERCENT)continue;const c=URL.elideDataURI(t.url),l=t.transferSize||0,u=(1-n)*l;let d;i+=u,c.includes("?")&&r++,a&&(d={type:"debugdata",...a}),s.push({url:c,debugData:d,cacheLifetimeMs:1e3*o,cacheHitProbability:n,totalBytes:l,wastedBytes:u})}s.sort((e,t)=>e.cacheLifetimeMs-t.cacheLifetimeMs||t.totalBytes-e.totalBytes||e.url.localeCompare(t.url));const a=Audit.computeLogNormalScore(i,t.options.scorePODR,t.options.scoreMedian),o=[{key:"url",itemType:"url",text:str_(i18n.UIStrings.columnURL)},{key:"cacheLifetimeMs",itemType:"ms",text:str_(i18n.UIStrings.columnCacheTTL),displayUnit:"duration"},{key:"totalBytes",itemType:"bytes",text:str_(i18n.UIStrings.columnTransferSize),displayUnit:"kb",granularity:1}],n={wastedBytes:i},c=Audit.makeTableDetails(o,s,n);return{score:a,numericValue:i,numericUnit:"byte",displayValue:str_(UIStrings.displayValue,{itemCount:s.length}),extendedInfo:{value:{results:s,queryStringCount:r}},details:c}})}}module.exports=CacheHeaders,module.exports.UIStrings=UIStrings;